まず関連ドキュメントをざっと確認して、要件と現在の構成を把握します。README、ユーザーマニュアル、初期仕様書を同時に開きます。

[3 tools called]

まず要件と現状のMVPを確認しました。これを踏まえ、全体の実装ロードマップをフェーズ分割で提示します。以降はこの順で細かく実装していけば、そのまま完成に近づきます。

## マイルストーン計画（全体像）
- [x] M0 骨格整備・配線の整合（1日）
  - [x] フロントのAPIパスをバックエンドに合わせて統一
  - [x] 共通のエラーハンドリングとローディング、`AbortController` 導入
  - [x] 既存 `GET /healthz` の疎通とCIのスモーク維持
- [x] M1 自作文/段落注釈のMVP完成（2–3日）
  - [x] `POST /api/sentence/check` と `POST /api/text/assist` を最小実装（LLM/RAGなし・決定的ロジック）
  - [x] `models/sentence.py` / `models/text.py` のスキーマ確定、フロント2パネル連携
- [x] M2 WordPack（周辺知識）MVP（2–3日）
  - [x] `POST /api/word/pack` を最小返却で実装（固定/規則ベースの生成）
  - [x] 発音は g2p-en/簡易テーブルで `ipa/syllables/stress` を返却（暫定）
- [x] M3 RAG基盤導入（3–5日）
  - [x] ChromaDB（Dockerで同梱）、埋め込みプロバイダ切替（`src/backend/providers.py`）
  - [x] インデクシングスクリプトと取得統合、`citations` と `confidence` を各レスポンスに付与
- [x] M4 SRS（復習）とカードUI完了（3–4日）
  - [x] `GET /api/review/today` / `POST /api/review/grade` 実装（簡易SM-2、まずはSQLite or in-memory）
  - [x] `CardPanel.tsx` を `/api/review/*` に接続、1日5枚のループが回ることを保証
- [x] M5 発音強化とUX仕上げ（2–4日）
  - [x] cmudict/g2p-enの精度改善、IPA・強勢・連結ノートの品質改善
  - [x] 設定トグル（発音ON/OFF）、再生成の粒度指定（全体/例文/コロケ）
- [ ] M6 運用・品質（継続）
  - [ ] `structlog` のJSONログ整備、p95応答時間の計測、タイムアウト/リトライ、エラーメトリクス
  - [ ] E2Eのスモーク（Playwright任意）、CIのカバレッジ閾値

## バックエンド実装（詳細）
- 構成
  - ルート: `src/backend/main.py`（CORS/ログ/ルータ登録）
  - ルータ: `src/backend/routers/{word,text,sentence,review}.py`
  - モデル: `src/backend/models/{word,text,sentence,review}.py`
  - フロー: `src/backend/flows/{word_pack,reading_assist,feedback}.py`（M1–M2は規則/ダミー、M3でRAG統合）
  - プロバイダ: `src/backend/providers.py`（LLM/Embedding 抽象と実体）
- APIスキーマ（要点）
  - SentenceCheckResponse: `issues[] {what,why,fix}`, `revisions{casual,formal,academic?}`, `exercise{q,a}`
  - TextAssistResponse: `sentences[] {raw, syntax{subject,predicate,mods[]}, terms[]{lemma,gloss_ja,ipa,...}, paraphrase}`, `summary`, `citations[]`
  - WordPackResponse: `lemma, pronunciation{ipa_GA,syllables,stress_index,linking_notes[]}, senses≤3, collocations{general,academic}, contrast≤3, examples, etymology{note,confidence}, study_card`
  - Review: `GET today -> items[] {id,prompt,type}`, `POST grade {id,grade}` → 次回日時・履歴更新
- 非機能
  - タイムアウト/エラー分類、`confidence:"low"` の表示ポリシー
  - 将来のDB: 初期はファイル/SQLite、RAGはChromaコレクション分割（一般/学術）

## フロントエンド実装（詳細）
- 配線統一（最初に実施）
  - `SentencePanel.tsx`: `POST {apiBase}/sentence/check`（現状ほぼ合致）
  - `AssistPanel.tsx`: `POST {apiBase}/text/assist` に変更（ベースURLの一時回避を不要化）
  - `CardPanel.tsx`: `/cards/*` から `/api/review/*` へ移行（`today`/`grade`）
  - `SettingsContext.tsx`: 既定 `apiBase` を `/api` に、Vite開発時はプロキシ or 明示URLを利用
- 共通UX
  - 送信中はフォームdisable、結果は `role="status"`、エラーは `role="alert"`
  - すべて `AbortController` を導入（連打時に前回をキャンセル）
  - 欠落項目の明示（例：「学術コロケ：該当なし」）
- テスト
  - 各パネルのAPI呼び出しをモック化したレンダリングテスト（Jest/React Testing Library）

## RAG/LLM・発音・SRSの要点
- RAG（M3）
  - コレクション: `word_snippets`, `domain_terms`、`k=6`、`citations` 埋め込み
  - 取得失敗や低信頼では「最小カード + 不確実バッジ」
- 発音（M2→M5）
  - MVP: g2p-en→IPA変換（限定カバレッジ）→M5でcmudictと例外辞書
- SRS（M4）
  - 簡易SM-2: `ease∈[1.5,3.0]`、`correct/partial/wrong`で間隔更新、`now + interval` の次回

## 受け入れ基準（Doneの定義）
- 自作文・注釈・WordPack・復習の4機能が実行でき、各レスポンスに `citations`（RAG導入後）または欠落明示がある
- p95: 注釈≤5s、WordPack≤5s、カード≤1.5s（M3以降）
- UIは単一ページ、キーボード操作（Alt+1..4, `/`）とアクセシビリティ属性が機能
- CIでAPIスモーク＋ユニット（pytest）とフロントの基本レンダリングが通過

## 直近の着手項目（M1 完了）
– 上記のM1項目は完了しました。

まとめ
- フロントはまずAPIパス整合と共通フェッチ基盤を整備。バックエンドは自作文/注釈→WordPack→RAG→SRSの順で拡張。各段階で欠落明示と`confidence`運用を徹底し、CIテストを並走させて確実に前進します。