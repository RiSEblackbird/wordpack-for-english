name: CI

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: Backend tests (pytest)
    runs-on: ubuntu-latest
    env:
      FIRESTORE_PROJECT_ID: wordpack-ci
      FIRESTORE_EMULATOR_PORT: 8080
      FIRESTORE_EMULATOR_HOST: ""
      ENABLE_FIRESTORE_EMULATOR: "false"
    strategy:
      matrix:
        python-version: ['3.13']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install langgraph

      - name: Run pytest
        env:
          PYTHONPATH: apps/backend
        run: |
          if [ "${ENABLE_FIRESTORE_EMULATOR}" = "true" ]; then
            npm install -g firebase-tools
            FIRESTORE_EMULATOR_HOST="127.0.0.1:${FIRESTORE_EMULATOR_PORT}" FIRESTORE_PROJECT_ID="${FIRESTORE_PROJECT_ID}" firebase emulators:exec --only firestore --project "${FIRESTORE_PROJECT_ID}" --config firebase.json "pytest" | cat
          else
            pytest | cat
          fi

  security_headers:
    name: Security headers tests (pytest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set SESSION_SECRET_KEY for CI
        # Settings 検証で必須のため、CI 実行ごとにランダム値を注入する（実運用の秘密鍵は不要）。
        run: |
          python - <<'PY' >> "$GITHUB_ENV"
          import secrets
          print("SESSION_SECRET_KEY=" + secrets.token_hex(32))
          PY

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install langgraph

      - name: Prepare production-like env file for security header checks
        run: cp .env.ci .env

      - name: Run security headers pytest suite
        env:
          PYTHONPATH: apps/backend
        run: pytest -q --no-cov tests/test_security_headers.py

  frontend:
    name: Frontend tests (vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run vitest
        run: npm test -- --coverage --silent

  playwright_smoke:
    name: Playwright smoke (PR critical flows)
    runs-on: ubuntu-latest
    needs:
      - backend
      - frontend
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/frontend/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set SESSION_SECRET_KEY for CI
        # Settings 検証で必須のため、CI 実行ごとにランダム値を注入する（実運用の秘密鍵は不要）。
        run: |
          python - <<'PY' >> "$GITHUB_ENV"
          import secrets
          print("SESSION_SECRET_KEY=" + secrets.token_hex(32))
          PY

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install langgraph

      - name: Install frontend dependencies
        working-directory: apps/frontend
        run: npm ci

      - name: Install Playwright dependencies
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Run Playwright smoke suite
        # PR では主要導線のみを実行し、短時間で回帰を検知する。
        run: |
          npx playwright test \
            -c tests/e2e/playwright.config.ts \
            tests/e2e/auth.spec.ts \
            tests/e2e/guest.spec.ts \
            tests/e2e/wordpack.spec.ts

      - name: Upload Playwright artifacts
        # 失敗時のスクリーンショット/トレース/HTML レポートを回収する。
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-artifacts
          path: |
            playwright-report/
            test-results/
          retention-days: 90
          if-no-files-found: ignore

  cloud_run_guard:
    name: Cloud Run config guard
    runs-on: ubuntu-latest
    needs:
      - security_headers
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set SESSION_SECRET_KEY for CI
        # Settings 検証で必須のため、CI 実行ごとにランダム値を注入する（実運用の秘密鍵は不要）。
        run: |
          python - <<'PY' >> "$GITHUB_ENV"
          import secrets
          print("SESSION_SECRET_KEY=" + secrets.token_hex(32))
          PY

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint deploy script
        run: shellcheck scripts/deploy_cloud_run.sh

      - name: Dry-run Cloud Run deployment
        run: ./scripts/deploy_cloud_run.sh --dry-run --env-file configs/cloud-run/ci.env --project-id ci-placeholder-project --region asia-northeast1 --service wordpack-backend


  deploy_production:
    name: CD / Deploy to production (Cloud Run)
    runs-on: ubuntu-latest
    needs:
      - backend
      - security_headers
      - frontend
      - ui_smoke
      - cloud_run_guard
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      CLOUD_RUN_PROJECT_ID: ${{ secrets.GCP_SA_PROJECT_ID }}
      CLOUD_RUN_REGION: asia-northeast1
      CLOUD_RUN_ENV_FILE: .env.deploy
      SKIP_FIRESTORE_INDEX_SYNC: "false"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Materialize production env file
        # シークレットに保存した base64 文字列から .env.deploy を復元し、後続の検証に備える。
        env:
          CLOUD_RUN_ENV_FILE: ${{ env.CLOUD_RUN_ENV_FILE }}
          CLOUD_RUN_ENV_FILE_BASE64: ${{ secrets.CLOUD_RUN_ENV_FILE_BASE64 }}
        run: |
          if [ -z "${CLOUD_RUN_ENV_FILE_BASE64}" ]; then
            echo "::error::CLOUD_RUN_ENV_FILE_BASE64 secret is not set. Add a base64-encoded .env.deploy for production deploys." >&2
            exit 1
          fi

          echo "::add-mask::${CLOUD_RUN_ENV_FILE_BASE64}"
          echo "${CLOUD_RUN_ENV_FILE_BASE64}" | base64 --decode > "${CLOUD_RUN_ENV_FILE}"
          echo "Restored ${CLOUD_RUN_ENV_FILE} from CLOUD_RUN_ENV_FILE_BASE64."

      - name: Validate deployment inputs
        # 秘密情報とデプロイ用の環境ファイルが揃っているか事前に検証し、原因が分かりやすい失敗に変換する。
        env:
          CLOUD_RUN_PROJECT_ID: ${{ env.CLOUD_RUN_PROJECT_ID }}
          CLOUD_RUN_ENV_FILE: ${{ env.CLOUD_RUN_ENV_FILE }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          missing=0
          if [ -z "${CLOUD_RUN_PROJECT_ID}" ]; then
            echo "::error::CLOUD_RUN_PROJECT_ID is not set. Register the production project ID as a repository secret or variable." >&2
            missing=1
          fi
          if [ ! -f "${CLOUD_RUN_ENV_FILE}" ]; then
            echo "::error::Deployment env file '${CLOUD_RUN_ENV_FILE}' is missing. Create it based on env.deploy.example and store it securely." >&2
            missing=1
          fi
          if [ -z "${GCP_SA_KEY}" ]; then
            echo "::error::GCP_SA_KEY is not set. Register the production service account key as a repository secret." >&2
            missing=1
          fi
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi
          echo "Inputs validated. Proceeding to authenticated deployment."

      - name: Authenticate to Google Cloud with service account key
        # CI 成功後にのみ実行される本番デプロイなので、サービスアカウントキーで明示的に認証する。
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        # gcloud CLI をプロジェクト/リージョンに合わせて準備する。Cloud Run / Cloud Build は GA コマンドのみ使用。
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.CLOUD_RUN_PROJECT_ID }}

      - name: Set up Node.js for Firebase CLI
        # Firestore インデックス同期に Firebase CLI（GA）を使用するため Node.js を用意する。
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Firebase CLI
        # firebase deploy --only firestore:indexes は GA であり、gcloud alpha より安定している。
        run: npm install -g firebase-tools

      - name: Set up Python
        # デプロイスクリプトが python -m apps.backend.backend.config で設定を検証するため Python 環境を用意する。
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python dependencies
        # Pydantic 設定検証など、デプロイ前の dry-run に必要な依存をインストールする。
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run production Cloud Run release
        # Firestore インデックス同期の有無は環境変数で制御し、Makefile 側で一元管理する。
        # TOOL=firebase で安定版の Firebase CLI を使い、gcloud alpha を回避する。
        env:
          CLOUD_RUN_PROJECT_ID: ${{ env.CLOUD_RUN_PROJECT_ID }}
          CLOUD_RUN_REGION: ${{ env.CLOUD_RUN_REGION }}
          CLOUD_RUN_ENV_FILE: ${{ env.CLOUD_RUN_ENV_FILE }}
          SKIP_FIRESTORE_INDEX_SYNC: ${{ env.SKIP_FIRESTORE_INDEX_SYNC }}
        run: |
          make release-cloud-run \
            PROJECT_ID="${CLOUD_RUN_PROJECT_ID}" \
            REGION="${CLOUD_RUN_REGION}" \
            ENV_FILE="${CLOUD_RUN_ENV_FILE}" \
            SKIP_FIRESTORE_INDEX_SYNC="${SKIP_FIRESTORE_INDEX_SYNC}" \
            TOOL=firebase

      - name: Summarize deployment outcome
        if: ${{ always() }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            ICON="✅"
          elif [ "$STATUS" = "cancelled" ]; then
            ICON="⚠️"
          else
            ICON="❌"
          fi

          {
            echo "## Production deployment"
            echo "- Status: ${ICON} ${STATUS}"
            echo "- Commit: ${{ github.sha }}"
            echo "- Actor: ${{ github.actor }}"
            echo "- Target project: ${CLOUD_RUN_PROJECT_ID}"
            echo "- Region: ${CLOUD_RUN_REGION}"
            echo "- Env file: ${CLOUD_RUN_ENV_FILE}"
            echo "- SKIP_FIRESTORE_INDEX_SYNC: ${SKIP_FIRESTORE_INDEX_SYNC}"
          } >> "$GITHUB_STEP_SUMMARY"

