name: Deploy to production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

concurrency:
  group: deploy-production-${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy after CI success
    # CI 完了後に main ブランチ向け push イベントが成功した場合のみ本番デプロイを行う
    # （PR の CI 成功だけではデプロイしない）
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    env:
      CLOUD_RUN_PROJECT_ID: ${{ secrets.GCP_SA_PROJECT_ID }}
      CLOUD_RUN_REGION: asia-northeast1
      CLOUD_RUN_ENV_FILE: .env.deploy
      SKIP_FIRESTORE_INDEX_SYNC: "false"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Materialize production env file
        # シークレットに保存した base64 文字列から .env.deploy を復元し、後続の検証に備える。
        env:
          CLOUD_RUN_ENV_FILE: ${{ env.CLOUD_RUN_ENV_FILE }}
          CLOUD_RUN_ENV_FILE_BASE64: ${{ secrets.CLOUD_RUN_ENV_FILE_BASE64 }}
        run: |
          if [ -z "${CLOUD_RUN_ENV_FILE_BASE64}" ]; then
            echo "::error::CLOUD_RUN_ENV_FILE_BASE64 secret is not set. Add a base64-encoded .env.deploy for production deploys." >&2
            exit 1
          fi

          echo "::add-mask::${CLOUD_RUN_ENV_FILE_BASE64}"
          echo "${CLOUD_RUN_ENV_FILE_BASE64}" | base64 --decode > "${CLOUD_RUN_ENV_FILE}"
          echo "Restored ${CLOUD_RUN_ENV_FILE} from CLOUD_RUN_ENV_FILE_BASE64."

      - name: Validate deployment inputs
        # 秘密情報とデプロイ用の環境ファイルが揃っているか事前に検証し、原因が分かりやすい失敗に変換する。
        env:
          CLOUD_RUN_PROJECT_ID: ${{ env.CLOUD_RUN_PROJECT_ID }}
          CLOUD_RUN_ENV_FILE: ${{ env.CLOUD_RUN_ENV_FILE }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          missing=0
          if [ -z "${CLOUD_RUN_PROJECT_ID}" ]; then
            echo "::error::CLOUD_RUN_PROJECT_ID is not set. Register the production project ID as a repository secret or variable." >&2
            missing=1
          fi
          if [ ! -f "${CLOUD_RUN_ENV_FILE}" ]; then
            echo "::error::Deployment env file '${CLOUD_RUN_ENV_FILE}' is missing. Create it based on env.deploy.example and store it securely." >&2
            missing=1
          fi
          if [ -z "${GCP_SA_KEY}" ]; then
            echo "::error::GCP_SA_KEY is not set. Register the production service account key as a repository secret." >&2
            missing=1
          fi
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi
          echo "Inputs validated. Proceeding to authenticated deployment."

      - name: Authenticate to Google Cloud with service account key
        # CI 成功後にのみ実行される本番デプロイなので、サービスアカウントキーで明示的に認証する。
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        # gcloud CLI をプロジェクト/リージョンに合わせて準備する。Cloud Run / Cloud Build は GA コマンドのみ使用。
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.CLOUD_RUN_PROJECT_ID }}

      - name: Set up Node.js for Firebase CLI
        # Firestore インデックス同期に Firebase CLI（GA）を使用するため Node.js を用意する。
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Firebase CLI
        # firebase deploy --only firestore:indexes は GA であり、gcloud alpha より安定している。
        run: npm install -g firebase-tools

      - name: Set up Python
        # デプロイスクリプトが python -m apps.backend.backend.config で設定を検証するため Python 環境を用意する。
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python dependencies
        # Pydantic 設定検証など、デプロイ前の dry-run に必要な依存をインストールする。
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run production Cloud Run release
        # Firestore インデックス同期の有無は環境変数で制御し、Makefile 側で一元管理する。
        # TOOL=firebase で安定版の Firebase CLI を使い、gcloud alpha を回避する。
        env:
          CLOUD_RUN_PROJECT_ID: ${{ env.CLOUD_RUN_PROJECT_ID }}
          CLOUD_RUN_REGION: ${{ env.CLOUD_RUN_REGION }}
          CLOUD_RUN_ENV_FILE: ${{ env.CLOUD_RUN_ENV_FILE }}
          SKIP_FIRESTORE_INDEX_SYNC: ${{ env.SKIP_FIRESTORE_INDEX_SYNC }}
        run: |
          make release-cloud-run \
            PROJECT_ID="${CLOUD_RUN_PROJECT_ID}" \
            REGION="${CLOUD_RUN_REGION}" \
            ENV_FILE="${CLOUD_RUN_ENV_FILE}" \
            SKIP_FIRESTORE_INDEX_SYNC="${SKIP_FIRESTORE_INDEX_SYNC}" \
            TOOL=firebase

      - name: Summarize deployment outcome
        if: ${{ always() }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            ICON="✅"
          elif [ "$STATUS" = "cancelled" ]; then
            ICON="⚠️"
          else
            ICON="❌"
          fi

          {
            echo "## Production deployment"
            echo "- Status: ${ICON} ${STATUS}"
            echo "- CI workflow: ${GITHUB_EVENT_WORKFLOW_RUN_NAME:-CI}"
            echo "- Commit: ${{ github.event.workflow_run.head_sha }}"
            echo "- Trigger branch: ${{ github.event.workflow_run.head_branch }}"
            echo "- Actor: ${{ github.actor }}"
            echo "- Target project: ${CLOUD_RUN_PROJECT_ID}"
            echo "- Region: ${CLOUD_RUN_REGION}"
            echo "- Env file: ${CLOUD_RUN_ENV_FILE}"
            echo "- SKIP_FIRESTORE_INDEX_SYNC: ${SKIP_FIRESTORE_INDEX_SYNC}"
          } >> "$GITHUB_STEP_SUMMARY"
