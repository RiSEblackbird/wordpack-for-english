---
description: >
  USE WHEN: UIスモークテストのシナリオを保守・実行・改善するとき
  GOAL: 主要動線の退行を10分以内に検知し、結果を継続的に可視化
  OUTPUT: シナリオ一覧、実行スケジュール、結果ログ、改善チケット
globs:
  - "tests/e2e/**/*.ts"
  - "tests/ui-smoke/**/*.ts"
alwaysApply: true
---

## Constraints
- スモーク対象は `UserManual.md` の主要操作（ログイン・単語検索など）を最小1シナリオずつカバーし、リリースごとに棚卸する。
- シナリオ定義は Given/When/Then 形式で記録し、UI識別子は role/label/text に揃える。`data-testid` は最後の手段とする。
- 実行環境は安定したテストデータと固定時刻（タイムゾーン UTC+0）を使用し、外部APIはモックで成功/失敗/タイムアウトの3系統を再現する。
- 1本のスモークスイートは 10分以内で完了させ、並列化または前処理で高速化する。
- フレーク検知目的で失敗時ログ/スクリーンショット/ネットワークトレースを保存する。保存期間は最低90日とし、アクセス手順をREADMEに記載する。

## Procedure
1. 主要ユーザーフローの優先順位をプロダクト仕様・`UserManual.md`・サポート問い合わせから整理し、P0/P1をラベル付けする。
2. 各フローに対して成功/失敗/境界ケースを洗い出し、スモーク対象を「成功パス」「代表的な失敗メッセージ」に限定してシナリオをドキュメント化する。
3. テストコードを Accessibility API ベースで更新し、共通セットアップ（ログイン、データseed）をヘルパーに集約してDRYを維持する。
4. 実行スケジュール（毎日02:00 UTC、自動デプロイ前、手動リリース前）をCIに設定し、成否と所要時間をメトリクスでダッシュボード化する。
5. 失敗時は1営業日以内に一次解析し、原因分類（テスト不備/製品バグ/環境）のチケットを起票。再発防止策を次回スプリント計画に反映する。

## Gates
- スモークスイートが2回連続で失敗したまま放置しない。再実行と是正策を完了するまでデプロイをブロックする。
- 新規UI機能が主要動線に影響する場合、コードマージ前に該当スモークシナリオを更新または追加し、CI緑を確認する。
- テストインフラ変更（ブラウザバージョン、クラウド実行環境など）はロールアウト前にベースライン比較（成功率、p95時間）を計測する。

## Success Criteria
- P0 UIフローのカバレッジが常時100%であり、実行結果ダッシュボードに過去90日分の履歴が残っている。
- スモーク失敗の一次解析を1営業日以内に完了し、原因カテゴリと対処チケットが紐付いている。
- スイートの平均実行時間が 10分以内、失敗率が 月次で 2% 以下に維持されている。
- 主要障害の振り返りで、スモークテストが検知した事例と見逃した事例をレビューし、改善項目が次スプリントに反映される。

## References
- @tests/e2e
- @README.md
- @UserManual.md
